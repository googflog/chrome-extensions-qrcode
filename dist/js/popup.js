"use strict";$(function(){function a(e){$("#qr").html(""),$("#qr").qrcode(e);var t,o,n,a,i,r,l,c=e.match(/^https?:\/{2,}(.*?)(?:\/|\?|#|$)/)[1],s=(t=new Date,o=t.getFullYear().toString(),n=(t.getMonth()+1).toString(),a=t.getDate().toString(),i=t.getHours().toString(),r=t.getMinutes().toString(),l=t.getSeconds().toString(),o+n+a+i+r+l),d=$("canvas")[0].toDataURL();$(".download").attr("href",d),$(".download").attr("download","qr-"+s+"-"+c+".png")}function i(e){$(".alert").html(e).show();setTimeout(function(){$(".alert").slideUp(400)},3e3)}function l(){var e=localStorage.getItem("qrcodeextensions12345");if(e){var t=JSON.parse(e);return console.log(t),t}return!1}function n(e,t){var o=l(),n=[];console.log("historyListObj",o);var a=!1;if(o)for(var i in o)n.push({url:o[i].url,title:o[i].title,date:o[i].date}),e==o[i].url&&(a=!0);a||n.push({url:e,title:t,date:new Date}),30<n.length&&n.shift();var r=JSON.stringify(n);localStorage.setItem("qrcodeextensions12345",r)}var r,e=function(){var e={};if(1<document.location.search.length)for(var t=document.location.search.substring(1).split("&"),o=0,n=t.length;o<n;o++){var a=t[o].split("="),i=decodeURIComponent(a[0]),r=decodeURIComponent(a[1]);e[i]=decodeURIComponent(r)}return e}(),c="",s="";chrome.storage.sync.get({bitly_access_token:"",bitly_domain:"bit.ly"},function(e){""!=e.bitly_access_token.length?(console.log("[ Load ]",e.bitly_access_token),c=e.bitly_access_token):(console.log("[ NoLoad ]"),c="ebd7a67d641fb54e4c84e2571369de37bbb79a12"),s=e.bitly_domain}),$(".version").append(chrome.runtime.getManifest().version);var t,d=$("textarea"),o=$(".contets"),u=$("body");if(e.url){var h=e.url,m=e.title;a(h),d.val(h),n(h,m),o.addClass("expansion"),u.addClass("context_mode")}else if(chrome.tabs)chrome.tabs.getSelected(null,function(e){var t=decodeURIComponent(e.url),o=e.title;a(t),d.val(t),n(t,o)});else{var p=decodeURIComponent(window.location.href);$("#qr").qrcode(p),d.val(p)}$(document).on("click","#qr",function(){$(".contets").hasClass("expansion")?$(".contets").removeClass("expansion"):$(".contets").addClass("expansion")}),$("textarea").on("keydown",function(){clearTimeout(t),t=setTimeout(function(){var e=$("textarea").val().toString();e.match(/[\u30a0-\u30ff\u3040-\u309f\u3005-\u3006\u30e0-\u9fcf]/)?(console.log("JP",e),a(e=Encoding.convert(e,"SJIS"))):(console.log("EN",e),a(encodeURI(e))),$(".copy").show()},300)}),$("textarea").on("click",function(){$(this).addClass("click-open")}),$(".undo").on("click",function(){$("textarea").val(r),a(encodeURI($("textarea").val())),$(".bitly").show(),$(".undo").hide(),$(".url").removeClass("bit-mode"),$(".copy").hide()}),$(".copy").on("click",function(){!function(e){var t=document.createElement("div"),o=document.createElement("pre");o.style.webkitUserSelect="auto",o.style.userSelect="auto",t.appendChild(o).textContent=e;var n=t.style;n.position="fixed",n.right="200%",document.body.appendChild(t),document.getSelection().selectAllChildren(t);var a=document.execCommand("copy");return document.body.removeChild(t),a}($("textarea").val())?i("COPY FAILURE!"):i("COPYED!")}),$(".bitly").on("click",function(){var e,t,o,n;r=$("textarea").val(),(e=r,t=encodeURIComponent(e),o="https://api-ssl.bitly.com/v3/shorten?access_token="+c+"&longUrl="+t+"&domain="+s,n=new $.Deferred,$.ajax({type:"get",url:o,dataType:"jsonp",processData:!1,contentType:!1,success:n.resolve,error:n.reject}),n.promise()).done(function(e){e.data.url?($(".bitly").hide(),$(".undo").show(),$(".copy").show(),$(".url").addClass("bit-mode"),$("textarea").val(e.data.url),a(e.data.url),$("textarea")[0].select()):i(e.status_txt.replace(/_/g," "))})}),$(".history").on("click",function(){$(".contets_inline").addClass("history"),$(".history-list").show(),$(".back").show(),$(".history-clear").show(),$(".option").show(),function(){var e=l();if(e.reverse(),e)for(var t in $(".history-list ul").html(""),e)$(".history-list ul").append('<li data-obj="'+e[t].url+'"><dl><dt>'+e[t].title+"</dt><dd>"+e[t].url+"</dd></dl></li>")}()}),$(".back").on("click",function(){$(".contets_inline").removeClass("history")}),$(document).on("click",".history-list li",function(){var e=$(this).data("obj");$("textarea").val(e),a(encodeURI($("textarea").val())),$(".contets_inline").removeClass("history")}),$(".option").on("click",function(){chrome.runtime.openOptionsPage?chrome.runtime.openOptionsPage():window.open(chrome.runtime.getURL("options.html"))});new PerfectScrollbar(".history-list",{})});